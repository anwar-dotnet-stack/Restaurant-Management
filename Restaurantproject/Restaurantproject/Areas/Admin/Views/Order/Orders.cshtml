@using Restaurantproject.Areas.Admin.Models
@model OrderViewModel

@{
    ViewData["Title"] = "Orders";
}

<br />
<div class="container mt-4">

<h2 class="text-center mb-4 text-primary fw-bold">
        <i class="bi bi-basket2"></i> @localizer["Order Management System"] </h2>
<br />

    <!-- قسم عرض الطلبات  -->
    <div class="card shadow-lg mb-5">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list-check"></i>@localizer["Previous orders"]  </h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover table-bordered mb-0 align-middle">
                <thead class="table-primary">
                    <tr>
            <th>@localizer["Order Number"]</th>
            <th>@localizer["Customer Name"]</th>
            <th>@localizer["Phone Number"]</th>
            <th>@localizer["Address"]</th>
            <th>@localizer["Address"]</th>
            <th>@localizer["Status"]</th>
            <th>@localizer["Total"]</th>
            <th>@localizer["Order Details"]</th>
        </tr>
    </thead>

    <tbody>
    @if (Model.Orders != null && Model.Orders.Any())
    {
        @foreach (var order in Model.Orders)
        {
            <tr>
                <td>@order.OrderId</td>
                <td>@order.CustomerName</td>
                <td>@order.PhoneNumber</td>
                <td>@order.Address</td>
                <td>@order.OrderDate.ToString("yyyy-MM-dd HH:mm")</td>
                <td>
                    @if (order.Status == "Under preparation")
                    {
                        <span class="badge bg-warning text-dark">@localizer["Under preparation"]</span>
                    }
                    else if (order.Status == "Completed")
                    {
                        <span class="badge bg-success">@localizer["Delivered"]</span>
                    }
                    else
                    {
                       <span class="badge bg-secondary">@order.Status</span>
                    }
                </td>
                <td>@order.TotalAmount.ToString("C")</td>

               <td>
                   <button class="btn btn-sm btn-outline-info" type="button"
                           data-bs-toggle="collapse" data-bs-target="#details_@order.OrderId">@localizer["View Details"] </button>

                   <div class="collapse mt-2" id="details_@order.OrderId">
                       <ul class="list-group">
                           @foreach (var detail in order.OrderDetails)
                           {
                               <li class="list-group-item d-flex justify-content-between align-items-center">
                                   @detail.MenuItem.Name
                                   <span class="badge bg-primary rounded-pill">@detail.Quantity ×</span>
                               </li>
                           }
                       </ul>
                   </div>

                              <form asp-action="DeleteOrder" asp-route-id="@order.OrderId" method="post" style="display:inline;">
                                  @Html.AntiForgeryToken()
                                  <button type="submit" class="btn btn-danger btn-sm"
                                  onclick="return confirm('Are you sure you want to delete this order?');">
                                      <i class="fa fa-trash"></i> Delete
                                  </button>
                              </form>

               </td>

           </tr>

                           
       }
   
   }
    else
    {
        <tr>
            <td colspan="6" class="text-center text-muted py-4">🚫 No requests currently available</td>
        </tr>
    }

                 
    </tbody>
</table>
        </div>
    </div>
<hr />

<!-- New Order Addition Form -->
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="bi bi-plus-circle"></i>@localizer["Add New Order"]</h4>
                </div>
        <div class="card-body">
<form asp-action="Create" method="post">

    <!-- Customer Data -->
    <div class="row mb-2">
        <div class="col-md-4">
            <label class="form-label fw-bold">@localizer["Customer Name"]:</label>
            <input asp-for="NewOrder.CustomerName" class="form-control" required />
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">@localizer["Phone Number"]:</label>
            <input asp-for="NewOrder.PhoneNumber" class="form-control" />
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">@localizer["Address"]:</label>
            <input asp-for="NewOrder.Address" class="form-control" />
        </div>
    </div>

    <h5 class="mb-3 text-secondary"><i class="bi bi-egg-fried"></i>@localizer["Select Items"] :</h5>

    <div class="row">
        @foreach (var item in Model.MenuItems)
        {
            <div class="col-md-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                 <div class="form-check mb-2">
                <input type="checkbox"
                       class="menu-checkbox"
                       name="SelectedMenuItemIds"
                       value="@item.MenuItemId"
                       data-price="@item.Price.ToString("C")"
                       id="menuItem_@item.MenuItemId" />

                <label class="form-check-label fw-bold" for="menuItem_@item.MenuItemId">
                    @item.Name - <span class="text-muted">(@item.Price.ToString("C"))</span>
                </label>
            </div>


                <label>@localizer["Quantity"]:</label>
                <input type="number"
                       name="Quantities[@item.MenuItemId]"
                       value="1"
                       min="1"
                       class="form-control w-50 d-inline quantity-input" />
                </div>
            </div>
        </div>
    }
    </div>

         <div class="text-end mt-3">
             <h5>Total: <span id="totalAmount" class="text-success fw-bold">0.00</span></h5>
         </div>
         <div class="text-center mt-4">
             <button type="submit" class="btn btn-success px-5 py-2">
                 <i class="bi bi-check-circle"></i>@localizer["Add Order"]</button>
         </div>
 
</form>

    <!-- رسائل الخطأ -->
    @if (!ViewData.ModelState.IsValid)
    {
                    <div class="alert alert-danger mt-4">
                    <h6>Some errors have occurred. </h6>
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <p>@error.ErrorMessage</p>
            }
        </div>
    }
    
</div>

        <!-- JavaScript  لحساب الإجمالي التلقائي للطلب-->
       @section scripts {
        <script> function updateTotal() {
                let total = 0;
                document.querySelectorAll('.menu-checkbox').forEach(cb => {
                    const price = parseFloat(cb.getAttribute('data-price'));
                    const qtyInput = cb.closest('.card-body').querySelector('.quantity-input');
                    const quantity = parseInt(qtyInput.value);

                    if (cb.checked && !isNaN(price) && !isNaN(quantity)) {
                        total += price * quantity;
                    }
                });
                document.getElementById('totalAmount').textContent = total.toFixed(2);
            }

            document.querySelectorAll('.menu-checkbox, .quantity-input').forEach(el => {
                el.addEventListener('change', updateTotal);
                el.addEventListener('input', updateTotal);
            });
        </script>

        }
